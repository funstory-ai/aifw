## 中文地址识别（优先级与位图驱动）的设计方案

### 1. 目标与范围
- **目标**：以 NER 输出的 `PHYSICAL_ADDRESS` 片段为种子，结合正则/启发式对“中文地址 token”进行类型化识别与“按优先级顺序拼接”，得到完整、边界正确且可控的中文地址；并满足“语言门控，仅在中文启用”。
- **核心思想**：将地址拆解为有序的“token 类型层级”，用一个 `u32` 的位图表示一个地址片段当前已经覆盖的层级集合；左右扩展仅在“邻接层级”之间发生，跨层级跳跃被拒绝；同层级的互斥类型不共存（用于切断错误粘连）。
- **隐私判定**：仅当片段的“最低层级位”达到或低于“隐私阈值（道路门牌号及其之后）”时，片段才被视为可掩码的“私人地址”。


### 2. 地址 token 类型与优先级层级（从左到右）
按照“从宏观到细化”的真实书写顺序定义层级（左高右低），每个层级对应一个 bit（最高位=最大优先次序，最低位=最小优先次序）。

建议使用 11 个层级（可扩展），自高到低如下：

- L11 国家/地区：如“中国、中华人民共和国、中国大陆、台湾、香港、澳门、英国、美国、日本”等（含常见别称/简称；支持简繁）
- L10 行政-省级：如“浙江省、四川省、特别行政区、自治区、自治州、州、盟、地区”
- L9  行政-市级：如“杭州市、成都市、上海市”
- L8  行政-区/县级（互斥组）：如“浦东新区、越秀区、西湖区、红安县、××县、××旗”
- L7  街乡镇里村：如“街道、镇、乡、里、村、/开发区/经济技术开发区等功能区”
- L6  道路：如“路、街、道、巷、弄、里、胡同、段、期、大道、大街、环路、环线”等后缀的道路名
- L5  道路门牌号（隐私阈值起点）：如“88号、100号、501号、之3、-2（楼号/扩展号）”
- L4  小区/POI（地点）：如“花园、广场、中心、数码港、大厦、园、城、座、馆、廊、坊、府、湾”等 POI 词尾
- L3  楼宇/楼栋/楼座（Building Block）：如“号楼、栋、幢、座、B座、C栋、号館/號樓/館/樓”等
- L2  楼层（Floor）：如“18层、3层、3樓、F3（英文字母可选）”
- L1  单元/房号（Unit/Room）：如“单元、室、房、1403室、806房、401室”

说明：
- L8 为互斥组，区（区级）与县（县级/旗级）不能同时出现（同一地址仅一种）。
- “开发区/经济技术开发区”归入 L7（街乡镇里村层级），因为其语义在区/县之后、道路之前，作为功能性行政/片区层级。
- “楼/楼层”的语义歧义处理：
  - 出现在“号楼/号館/號樓/××栋/××幢/××座”结构中作为 L3（楼宇）；
  - 出现在“数字+层/樓”结构中作为 L2（楼层）。


### 3. 位图表示（`u32 addr_priorities`）
 - 每个层级分配一个 bit 位，最高位对应 L11，最低位对应 L1。映射规范如下：
  - bit18 = L11（国家/地区）
  - bit17 = L10（省）
  - bit16 = L9（市）
  - bit15 = L8（区/县/旗）
  - bit14 = L7（街/镇/乡/里/村/功能区）
  - bit13 = L6（道路）
  - bit12 = L5（门牌号）
  - bit11 = L4（小区/POI）
  - bit10 = L3（楼宇/楼栋/座）
  - bit9  = L2（楼层）
  - bit8  = L1（单元/房号）
  - bit7  = 保留（reserved）, bit0 - bit7 都是保留位
 - 对任何一个地址片段，`addr_priorities` 是它已覆盖层级的“并集”。例如：
  - “上海市浦东新区” → L9+L8（bit16+bit15）
  - “银城中路501号” → L6+L5（bit13+bit12）
  - “陆家嘴金融广场18层” → L4+L2（bit11+bit10）

辅助操作：
- `highest_bit(addr_priorities)`：返回当前集合中最高层级（最左）bit。
- `lowest_bit(addr_priorities)`：返回当前集合中最低层级（最右）bit。
- `is_adjacent(higher, lower)`：判断两个层级是否相邻（如 L9 与 L8、L6 与 L5）。


### 4. 同层级互斥
- 互斥组：L8（区/县/旗）。识别到一个 L8 后，禁止再把另一个 L8 并进同一地址片段。
- 可扩展互斥：将来需要时，可将同层的不同细分类（例如同一地址中不能出现两个不同的道路 L6）设为互斥；当前需至少确保 L8 互斥即可避免“两个地址粘连”。


### 5. Token 识别方式（正则/规则）
为保证可维护性与性能，采用“小而明确”的规则集合，而非一个超大正则：
- 国家/地区（L11）：匹配常见国家/地区名称及别称（如“中国/中华人民共和国/中国大陆/台湾/香港/澳门/英国/美国/日本”等），支持简繁与常见简称。
- 行政后缀（L10/L9/L8/L7）：匹配明确后缀词表（简繁体兼容）。
- 道路（L6）：匹配“通用名段 + 道路后缀词表”，允许轻分隔（空格、逗号）。
- 门牌号（L5）：匹配“数字 + 号/號”，可选 “之数字”“-数字”。
- POI（L4）：匹配通用 POI 词尾词表。
- 楼宇（L3）：匹配“数字 + 号楼/栋/幢/座/号館/號樓/館/樓/楼”等；支持英文字母楼座（如“B座”）。
- 楼层（L2）：匹配“数字 + 层/層/樓/F数字”。
- 单元/房号（L1）：匹配“数字（可含-）+ 单元/室/房”。

识别策略：
- 对 NER 输出的 `RecogEntity(PHYSICAL_ADDRESS)` 子串先做 token 化，得到它的 `addr_priorities`（可能包含多个层级）。
- 对纯文本扫描同样采用上述规则，识别候选 token，获得类型与范围。
- 避免使用复杂的 Unicode 巨集正则，尽量采用后缀词表 + 轻量匹配（或代码扫描）以规避编译/性能问题。


### 6. 右扩/左扩的“邻接层级”拼接规则
- 右扩规则：设当前片段集合最低层级为 `Lx`，候选 token 的最高层级为 `Ly`，从宏观往细化地扩展，满足任一即可右扩：
  - 严格相邻：`Ly = Lx - 1`。
  - 允许跳跃（白名单规则）：在特定情形允许跳过一层。例如：
    - 道路 → 小区/POI（`L6 → L4`）：可跳过 `L5（门牌号）`，以覆盖“未书写门牌号、直接进入小区/POI”的常见书写，如“珠海市香洲路明月花园12栋508房”。约束：
      - 两 token 间仅允许轻分隔（空格/逗号/换行等）；
      - 距离上限 ≤ 4 字符（可调）；
      - 小区/POI 需由已知 POI 词尾匹配确认。
  - 例如：已到 L6（道路），可右扩 L5（门牌号）；或按白名单从 L6 跳到 L4；之后继续 L3/L2/L1（各自相邻）。
- 左扩规则：设当前片段集合最高层级为 `Lx`，候选 token 的最低层级为 `Ly`，仅当 `Ly = Lx + 1` 时可左扩（从细化往宏观）。
  - 例如：已到 L6（道路），可左扩 L7（街镇），再左扩 L8（区/县），再 L9（市），再 L10（省），再 L11（国家/地区）。
- 互斥校验：若候选 token 的层级与已包含层级相同且为互斥组（如 L8），则拒绝合并（认为另起一个地址）。

允许的连接符与轻分隔（统一以“字符”为计量单位）：
- 轻分隔：空格、Tab、换行、英文/中文逗号（`,`、`，`）等；允许出现在 token 与 token 之间。
- 弱连接符：`之`、`-` 等可出现在 L5 之后的扩展中（如“之3”“-2”）。
- 阈值：轻分隔/弱连接符的“距离”需在合理范围（如 ≤5 字符），超过则认为不相邻。


### 7. 扫描流程（总体管线）
1) 输入：原始文本 + NER 输出的 `RecogEntity(PHYSICAL_ADDRESS)`（按起点排序）。
2) 预处理：过滤非中文语言；仅在中文（统称 zh）启用该流程。
3) 种子选择：从左到右，取一个 `PHYSICAL_ADDRESS` 种子；对该子串 token 化，得到 `addr_priorities` 与初始范围。
4) 右扩：
   - 在当前范围右侧顺序查找“下一个候选”：
     - 文本候选：按规则识别最近的地址 token；
     - NER 候选：如果下一个 `PHYSICAL_ADDRESS` 片段紧邻或仅隔轻分隔，也纳入候选（先 token 化）。
   - 对候选：验证右扩邻接层级 + 互斥 + 距离阈值 + “重地址前瞻阻断”（见 §8），通过则合并并更新集合与范围，继续右扩；否则停止。
   - 隐私阈值：右扩完成后，若 `addr_priorities` 的“最低层级位” ≤ L5（门牌号）则视为达到隐私阈值；
     - 例外：若出现 “POI + 楼层/房号”（如 L4+L2/L1）且 POI 在合理距离内，也视为隐私地址（覆盖“西湖数码港2号楼401室”“××广场18层”等）。
5) 左扩：
   - 在当前范围左侧查找候选文本 token（通常不再存在左侧 NER 地址片段，因为我们按起点单调前进）；
   - 验证左扩邻接层级 + 互斥 + 距离阈值，合并直至不能再左扩。
6) 产出该地址片段；跳到下一个未覆盖的种子，重复步骤 3~5。
7) 冲突消解（见 §9）并输出最终掩码片段。


### 8. 边界与阻断（防过度合并）
- 重地址前瞻阻断：在右扩过程中，若在近距离（如 ≤ 12 字符）内探测到“新的地址开头形态”（如“名称 + 行政/道路后缀”），则停止当前地址继续右扩，避免把两个地址粘连成一个。
- 重分隔符：句号、分号、问号、顿号、括号、斜杠、竖线等作为“硬边界”，立即停止扩展。
- 总长度上限：右扩累计字符上限（如 ≤48 字符）；超过视为异常书写，停止扩展。
- 名称段长度上限：用于 POI 名称的泛化段（汉字/ASCII 字母）设定字符上限（如 ≤16 字符），避免吸入过长非地址文本。


### 9. 与 NER 的集成
- 映射：`LOC/GPE/FAC/ADDRESS` → `PHYSICAL_ADDRESS`（已在 JS 层完成映射）。
- BIO 处理：支持 `B-`/`I-`/`E-`/`S-`；将 `S-` 视作单 token 的 Begin。
- 用法：NER 片段作为“高置信种子”，其 token 化得到 bitset；在扩展过程中，若右侧下一个 NER 片段与当前片段“仅轻分隔相邻”，也可当作候选进行“邻接校验后并入”。


### 10. 冲突消解与排序策略
当两个 span 重叠：
- 优先级 1：更“深层”的地址（包含更低层级 bit，如 L1/L2/L3），即最低层级位更小者优先；
- 优先级 2：更长跨度；
- 优先级 3：更早起点；
- 优先级 4：更高 NER 置信分数。
这样确保“完整地址片段”覆盖“POI 碎片”。


### 11. 语言门控与字符处理
- 仅当 `Language` 属于中文族（`zh/zh_cn/zh_tw/zh_hk/zh_hans/zh_hant`）时启用地址流程；其他语言完全跳过。
- UTF-8 感知扫描，保证不会截断中文多字节字符。
- 轻度归一：需要接受半角/全角空格与阿拉伯数字；支持中文数字（“一二三”）可作为增量工作。


### 12. 性能与实现建议
- Token 识别尽量采用“后缀词表 + 小正则 + 代码扫描”，避免极复杂单体正则导致编译/性能问题。
- 位图与邻接判定保证扩展逻辑 O(1) 判定，整体 O(n) 扫描。
- 右扩优先，左扩补全；轻分隔/距离/前瞻阻断作为“刹车”机制。


### 13. 判定与阈值（建议值，可调优）
- 轻分隔最大间距：4 字符（POI 与后续数字之间的距离上限）
- 右扩总字符上限：≤48 字符 (可调优的编译期常量)
- 前瞻阻断窗口：≤12 字符 （可调优的编译期常量）
- 泛化名称段长度：≤16 字符 （可调优的编译期常量）
- 隐私阈值：默认 L5（门牌号）及以下；例外允许 L4+L2/L1。


### 14. 典型用例（期望行为）
- “上海市浦东新区银城中路501号陆家嘴金融广场18层”
  - L9+L8+L6+L5+L4+L2 → 达到隐私阈值（L5），整段掩码。
- “我是吴光华，住在广州市越秀区北京西路黄埔花园13栋806房我的表哥在南昌市中山路2348号锦江花园6栋1403房”
  - 切成两个地址：
    - “广州市越秀区北京西路黄埔花园13栋806房”（L9+L8+L6+L4+L3+L1）
    - “南昌市中山路2348号锦江花园6栋1403房”（L9+L6+L5+L4+L3+L1）
  - 互斥与邻接规则避免粘连。
- “北京市朝阳区建国路 88 号”
  - 允许轻分隔（空格）；L9+L8+L6+L5，整段掩码。
 - “珠海市香洲路明月花园12栋508房”
  - 允许从 L6（道路）跳过 L5（门牌号）直达 L4（小区/POI），随后继续 L3（楼栋）→ L1（房号）；最终 L9+L6+L4+L3+L1，整段掩码。


### 15. 开发里程碑（不含代码细节）
- M1：实现 token 类型词表与小规则；为 NER 片段与文本窗口提供 token 化函数 → 输出 `addr_priorities` 与 token span。
- M2：实现基于位图的右扩/左扩与邻接判定、互斥校验、前瞻阻断与距离阈值。
- M3：实现隐私阈值判断与例外（POI+楼层/房号）。
- M4：整合到现有管线（仅中文）；实现冲突消解策略（更深层→更长→更早→更高分）。
- M5：测试集覆盖（上述经典用例 + 难例），参数调优。


### 16. 与现有逻辑的差异与收益
- 从“具体 case 打补丁”转为“通用的层级/位图驱动”机制，逻辑稳定、可解释、可扩展。
- 多语言无副作用（语言门控），与 NER 完全兼容（NER 作为种子、token 化后参与邻接扩展）。
- 可通过参数（窗口、阈值、层级词表）快速调优，支撑更多复杂场景。
